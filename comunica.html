<script>
    // Recuperar os dados do PHP usando AJAX
    var xmlhttp = new XMLHttpRequest();
    var url = "dados.php";

    xmlhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);

            // Verificar se há dados
            if (!data.graficos || !data.motoristas || !data.ocorrencias || !data.evasao_roleta) {
                console.error("Erro: Dados ausentes no JSON recebido.");
                return;
            }

            // Dados para o primeiro gráfico
            var labels = [];
            var ocorrenciaCounts = {};
            var actionCounts = {};

            data.graficos.forEach(function (item) {
                var label = item.ocorrencia;
                if (!labels.includes(label)) {
                    labels.push(label);
                }
                if (!ocorrenciaCounts[label]) {
                    ocorrenciaCounts[label] = 0;
                }
                ocorrenciaCounts[label] += 1;

                if (!actionCounts[label]) {
                    actionCounts[label] = {};
                }
                if (!actionCounts[label][item.acao]) {
                    actionCounts[label][item.acao] = 0;
                }
                actionCounts[label][item.acao] += 1;
            });

            // Preparar dados para o gráfico 1
            var dataCounts = labels.map(function (label) {
                return ocorrenciaCounts[label];
            });

            var actionTotals = {};
            for (var action in actionCounts) {
                for (var label in actionCounts[action]) {
                    if (!actionTotals[label]) {
                        actionTotals[label] = 0;
                    }
                    actionTotals[label] += actionCounts[action][label];
                }
            }

            // Renderizar o gráfico 1
            var ctx1 = document.getElementById('myChart1').getContext('2d');
            var myChart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade por Ocorrência',
                        data: dataCounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true, // Exibir a legenda
                            position: 'top' // Posição da legenda
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });

            // Preparar dados para a linha de ações no gráfico 2
            var actionLabels = Object.keys(actionCounts);
            var actionData = actionLabels.map(function (ocorrencia) {
                return Object.values(actionCounts[ocorrencia]);
            });

            // Renderizar o gráfico 2
            var ctx2 = document.getElementById('myChart2').getContext('2d');
            var myChart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(actionTotals),
                    datasets: [{
                        label: 'Quantidade por ocorrência',
                        data: Object.values(actionTotals),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true, // Exibir a legenda
                            position: 'top' // Posição da legenda
                        }
                    },
                    scales: {
                        x: {
                            stacked: true // Empilhar barras no eixo X
                        },
                        y: {
                            stacked: true // Empilhar barras no eixo Y
                        }
                    },
                    tooltips: {
                        callbacks: {
                            label: function (context) {
                                var label = context.label || '';
                                var value = context.parsed || 0;
                                return label + ': ' + value;
                            }
                        }
                    }
                }
            });

            // Preparar dados para o gráfico 3 (Evasão e Não Gira a Roleta)
            var motoristas = [];
            var evasao = [];
            var naoGiraRoleta = [];

            data.evasao_roleta.forEach(function (item) {
                motoristas.push(item.motorista);
                evasao.push(item.evasao);
                naoGiraRoleta.push(item.nao_gira_roleta);
            });

            // Renderizar o gráfico 3
            var ctx3 = document.getElementById('myChart3').getContext('2d');
            var myChart3 = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: motoristas,
                    datasets: [
                        {
                            label: 'Evasão',
                            data: evasao,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Motorista não gira a roleta',
                            data: naoGiraRoleta,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true, // Exibir a legenda
                            position: 'top' // Posição da legenda
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    var label = context.label || '';
                                    var value = context.raw || 0;
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });

            // Dados para a tabela
            var motoristaData = data.evasao_roleta;

            // Preencher a tabela
            var tableBody = document.querySelector("#motorista-table tbody");
            motoristaData.forEach(function (item) {
                var row = document.createElement("tr");

                // Adicionar células à linha da tabela
                var motoristaCell = document.createElement("td");
                motoristaCell.textContent = item.motorista;
                row.appendChild(motoristaCell);

                var totalCell = document.createElement("td");
                totalCell.textContent = item.total_geral;
                row.appendChild(totalCell);

                tableBody.appendChild(row);
            });

            // Exibir a tabela e gráficos
            document.getElementById('table-container').style.display = 'block';
            document.getElementById('chart1-container').style.display = 'block';
            document.getElementById('chart2-container').style.display = 'block';
            document.getElementById('chart3-container').style.display = 'block';
        }
    };

    xmlhttp.open("GET", url, true);
    xmlhttp.send();
</script>